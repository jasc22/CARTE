# Authenticate once
$ctx = Connect-MgGraph -Scopes "User.Read.All"

# Reuse context in all subsequent calls
$users = Get-MgUser -All

foreach ($user in $users) {
    try {
        $photo = Get-MgUserPhoto -UserId $user.Id -Context $ctx -ErrorAction Stop
        if ($photo) {
            [PSCustomObject]@{
                DisplayName = $user.DisplayName
                UserPrincipalName = $user.UserPrincipalName
                HasPhoto = $true
            }
        }
    } catch {
        # skip users without photo
    }
}



$tkn = Invoke-MgGraphRequest -Uri "https://graph.microsoft.com/v1.0/users/$($userId)/photo/`$value" -ContentType "image/jpeg" -OutputType HttpResponseMessage
