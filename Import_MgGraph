$BasePath = "C:\MgGraph"

# Get all 2.24.0 directories under each subdirectory of C:\MgGraph
$ModulePaths = Get-ChildItem -Path $BasePath -Directory | ForEach-Object {
    $VersionPath = Join-Path $_.FullName "2.24.0"
    if (Test-Path $VersionPath) { $VersionPath }
}

if ($ModulePaths.Count -eq 0) {
    Write-Host "No 2.24.0 directories found under $BasePath!" -ForegroundColor Red
    exit
}

# Separate Microsoft.Graph.Authentication and Microsoft.Graph from other modules
$AuthPath = $ModulePaths | Where-Object { $_ -match "Microsoft.Graph.Authentication\\2.24.0" }
$GraphPath = $ModulePaths | Where-Object { $_ -match "Microsoft.Graph\\2.24.0" }
$OtherModules = $ModulePaths | Where-Object { $_ -ne $AuthPath -and $_ -ne $GraphPath }

# Function to load modules using ipmo and print what gets loaded
function Load-Modules {
    param ($ModulePath)

    Write-Host "`nLoading modules from: $ModulePath`n" -ForegroundColor Cyan
    $ModuleFiles = Get-ChildItem -Path $ModulePath -Include "*.psm1", "*.psd1"

    if ($ModuleFiles.Count -eq 0) {
        Write-Host "No module files found in $ModulePath!" -ForegroundColor Yellow
        return
    }

    foreach ($Module in $ModuleFiles) {
        try {
            Write-Host "Loading: $($Module.FullName)"
            ipmo $Module.FullName -Force -Scope Global -ErrorAction Stop
            Write-Host "Successfully loaded: $($Module.Name)" -ForegroundColor Green
        } catch {
            Write-Host "Failed to load: $($Module.FullName) - $_" -ForegroundColor Red
        }
    }
}

# 1. Load Microsoft.Graph.Authentication first
if ($AuthPath) {
    Write-Host "`nLoading Microsoft.Graph.Authentication first from: $AuthPath`n" -ForegroundColor Magenta
    Load-Modules -ModulePath $AuthPath
} else {
    Write-Host "Microsoft.Graph.Authentication module not found, skipping!" -ForegroundColor Yellow
}

# 2. Load all other modules
foreach ($ModulePath in $OtherModules) {
    Load-Modules -ModulePath $ModulePath
}

# 3. Load Microsoft.Graph last
if ($GraphPath) {
    Write-Host "`nLoading Microsoft.Graph last from: $GraphPath`n" -ForegroundColor Blue
    Load-Modules -ModulePath $GraphPath
} else {
    Write-Host "Microsoft.Graph module not found, skipping!" -ForegroundColor Yellow
}

Write-Host "`nAll modules loaded successfully!" -ForegroundColor Green
