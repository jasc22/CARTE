$BasePath = "C:\MgGraph"

# Find all .psd1 and .psm1 files in any 2.24.0 subdirectory
$ModuleFiles = Get-ChildItem -Path $BasePath -Recurse -Include "*.psd1", "*.psm1" -ErrorAction SilentlyContinue | Select-Object -ExpandProperty FullName

if ($ModuleFiles.Count -eq 0) {
    Write-Host "No module files found in any 2.24.0 directories!" -ForegroundColor Red
    exit
}

# Print and load each module
foreach ($Module in $ModuleFiles) {
    Write-Host "Loading: $Module"
    try {
        ipmo $Module -Force -Scope Global -ErrorAction Stop
        Write-Host "Successfully loaded: $(Split-Path -Leaf $Module)" -ForegroundColor Green
    } catch {
        Write-Host "Failed to load: $Module - $_" -ForegroundColor Red
    }
}

Write-Host "`nAll modules processed!" -ForegroundColor Green
