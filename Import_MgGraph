# Define the base directory where the modules are stored
$BasePath = "C:\MgGraph"

# Get all subdirectories under $BasePath that contain a '2.24.0' folder
$ModulePaths = Get-ChildItem -Path $BasePath -Directory | ForEach-Object {
    $VersionPath = Join-Path $_.FullName "2.24.0"
    if (Test-Path $VersionPath) { $VersionPath }
}

if ($ModulePaths.Count -eq 0) {
    Write-Host "No 2.24.0 directories found under $BasePath!" -ForegroundColor Red
    exit
}

foreach ($ModulePath in $ModulePaths) {
    Write-Host "`nProcessing modules from: $ModulePath`n" -ForegroundColor Cyan

    # Ensure Microsoft.Graph.Authentication is loaded first if it exists
    $AuthModule = Get-ChildItem -Path $ModulePath -Filter "Microsoft.Graph.Authentication.psd1" | Select-Object -First 1
    if ($AuthModule) {
        try {
            Write-Host "Importing authentication module: $($AuthModule.FullName)"
            Import-Module $AuthModule.FullName -Force -Scope Global -ErrorAction Stop
        } catch {
            Write-Host "Failed to import authentication module: $($AuthModule.FullName) - $_" -ForegroundColor Red
        }
    }

    # Ensure Microsoft.Graph module is loaded
    try {
        Write-Host "Ensuring all Microsoft.Graph modules are loaded."
        Import-Module Microsoft.Graph -Force -Scope Global -ErrorAction Stop
    } catch {
        Write-Host "Failed to import Microsoft.Graph module - $_" -ForegroundColor Red
    }

    # Get all other .psd1 and .psm1 files, excluding Microsoft.Graph.Authentication.psd1
    $ModuleFiles = Get-ChildItem -Path $ModulePath -Include "*.psd1", "*.psm1" -Exclude "Microsoft.Graph.Authentication.psd1"

    foreach ($Module in $ModuleFiles) {
        try {
            Write-Host "Importing module: $($Module.FullName)"
            Import-Module $Module.FullName -Force -Scope Global -ErrorAction Stop
        } catch {
            Write-Host "Failed to import module: $($Module.FullName) - $_" -ForegroundColor Red
        }
    }
}

Write-Host "`nAll applicable modules from 2.24.0 subdirectories have been processed!" -ForegroundColor Green
