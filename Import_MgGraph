# Define the base directory where versions are located
$BasePath = "C:\MgGraph\ModuleName"

# Get all first-level subdirectories named '2.24.0'
$ModulePaths = Get-ChildItem -Path $BasePath -Directory | Where-Object { $_.Name -eq "2.24.0" }

if ($ModulePaths.Count -eq 0) {
    Write-Host "No 2.24.0 directories found in $BasePath!" -ForegroundColor Red
    exit
}

foreach ($ModulePath in $ModulePaths) {
    Write-Host "`nProcessing modules from: $ModulePath`n" -ForegroundColor Cyan

    # Ensure Microsoft.Graph.Authentication is loaded first
    $AuthModule = Get-ChildItem -Path $ModulePath.FullName -Filter "Microsoft.Graph.Authentication.psd1" | Select-Object -First 1
    if ($AuthModule) {
        try {
            Write-Host "Importing authentication module: $($AuthModule.FullName)"
            Import-Module $AuthModule.FullName -Force -Scope Global -ErrorAction Stop
        } catch {
            Write-Host "Failed to import authentication module: $($AuthModule.FullName) - $_" -ForegroundColor Red
        }
    } else {
        Write-Host "Microsoft.Graph.Authentication.psd1 not found in $ModulePath!" -ForegroundColor Red
    }

    # Ensure Microsoft.Graph module is loaded
    try {
        Write-Host "Ensuring all Microsoft.Graph modules are loaded."
        Import-Module Microsoft.Graph -Force -Scope Global -ErrorAction Stop
    } catch {
        Write-Host "Failed to import Microsoft.Graph module - $_" -ForegroundColor Red
    }

    # Get all other .psd1 and .psm1 files, excluding Microsoft.Graph.Authentication.psd1
    $ModuleFiles = Get-ChildItem -Path $ModulePath.FullName -Include "*.psd1", "*.psm1" -Exclude "Microsoft.Graph.Authentication.psd1"

    foreach ($Module in $ModuleFiles) {
        try {
            Write-Host "Importing module: $($Module.FullName)"
            Import-Module $Module.FullName -Force -Scope Global -ErrorAction Stop
        } catch {
            Write-Host "Failed to import module: $($Module.FullName) - $_" -ForegroundColor Red
        }
    }
}

Write-Host "`nAll applicable modules from first-level 2.24.0 directories have been processed!" -ForegroundColor Green
