# Define the base directory where modules are stored
$BasePath = "C:\MgGraph"

# Get all first-level subdirectories under $BasePath
$Subdirectories = Get-ChildItem -Path $BasePath -Directory

# Initialize arrays to store valid 2.24.0 paths
$ModulePaths = @()
$MicrosoftGraphPath = $null
$AuthenticationPath = $null

# Iterate through each subdirectory and check if it contains a '2.24.0' folder
foreach ($Subdir in $Subdirectories) {
    $VersionPath = Join-Path $Subdir.FullName "2.24.0"
    
    if (Test-Path $VersionPath) {
        if ($Subdir.Name -eq "Microsoft.Graph.Authentication") {
            $AuthenticationPath = $VersionPath  # Store Microsoft.Graph.Authentication to load first
        } elseif ($Subdir.Name -eq "Microsoft.Graph") {
            $MicrosoftGraphPath = $VersionPath  # Store Microsoft.Graph to load last
        } else {
            Write-Host "Found: $VersionPath" -ForegroundColor Green
            $ModulePaths += $VersionPath
        }
    } else {
        Write-Host "Skipping (No 2.24.0): $VersionPath" -ForegroundColor Yellow
    }
}

# If no valid paths are found, exit
if (-not $AuthenticationPath -and $ModulePaths.Count -eq 0 -and -not $MicrosoftGraphPath) {
    Write-Host "No 2.24.0 directories found under $BasePath!" -ForegroundColor Red
    exit
}

# Function to process module imports
function Import-ModulesFromPath {
    param ($ModulePath)
    
    Write-Host "`nProcessing modules from: $ModulePath`n" -ForegroundColor Cyan

    # Get all .psd1 and .psm1 files
    $ModuleFiles = Get-ChildItem -Path $ModulePath -Include "*.psd1", "*.psm1"

    foreach ($Module in $ModuleFiles) {
        try {
            Write-Host "Importing module: $($Module.FullName)"
            Import-Module $Module.FullName -Force -Scope Global -ErrorAction Stop
        } catch {
            Write-Host "Failed to import module: $($Module.FullName) - $_" -ForegroundColor Red
        }
    }
}

# 1. Load Microsoft.Graph.Authentication first if found
if ($AuthenticationPath) {
    Write-Host "`nLoading Microsoft.Graph.Authentication first from: $AuthenticationPath`n" -ForegroundColor Magenta
    Import-ModulesFromPath -ModulePath $AuthenticationPath
} else {
    Write-Host "Microsoft.Graph.Authentication\2.24.0 not found, skipping authentication module!" -ForegroundColor Yellow
}

# 2. Load all other modules (excluding Authentication and Microsoft.Graph)
foreach ($ModulePath in $ModulePaths) {
    Import-ModulesFromPath -ModulePath $ModulePath
}

# 3. Load Microsoft.Graph last if found
if ($MicrosoftGraphPath) {
    Write-Host "`nLoading Microsoft.Graph last from: $MicrosoftGraphPath`n" -ForegroundColor Blue
    Import-ModulesFromPath -ModulePath $MicrosoftGraphPath
} else {
    Write-Host "Microsoft.Graph\2.24.0 not found, skipping Microsoft.Graph module!" -ForegroundColor Yellow
}

Write-Host "`nAll applicable modules from 2.24.0 subdirectories have been processed!" -ForegroundColor Green
